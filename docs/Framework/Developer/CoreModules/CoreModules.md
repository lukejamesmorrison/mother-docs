# Core Modules

Core modules act as Mother's framework, enabling extension modules.

|Name											| Description|
|-												|-|
| [Activity Monitor](ActivityMonitor.md)    | Monitors functional block activity across cycles to enable safeguards like stopping and locking once the activity is complete.|
| [Almanac](Almanac.md)                     | Stores information about other grids running Mother including position and hostility.|
| [Block Catalogue](BlockCatalogue.md)      | Catalogues all functional blocks available on the grid for use in automations. |
| Command Bus				| Handles commands and routines executed by a player, or remotely from another grid. |
| [Configuration](Configuration.md) | Manages the configuration of Mother and its modules using the Programmable Block's `Custom Data`. |
| [Event Bus](EventBus.md) | Handles system events generated by the grid or other grids running Mother. This allows Mother to remain modular and only run when something has changed via event broadcasting. |
| [Intergrid Message Service](IntergridMessageService.md) | Handles communication between grids running Mother. |
| [Local Storage](LocalStorage.md) | Allows Mother to store information across cycles, even if an error occurs or a player hits `Recompile`. |
| Log | Logs information about the grid and Mother's activity. |
| [Security](Security.md) | Responsible for encrypting messages and and other system data. |





## Intergrid Communication Service

Sending messages between grids is a core capability of Mother, and this can be done in a variety of ways depending on your level of security.

### Sending Open Broadcast
The most common case is sending an open broadcast to other grids.  This is most appropriate for public channels.  An open broadcast will be sent to all grids on the antenna network channel.

Let's look at how we `ping` other grids:

```csharp
# IntergridMessageService.cs

public void Ping()
{
    Vector3D currentPosition = Mother.Grid.GetPosition();

    Dictionary<string, object> requestBody = new Dictionary<string, object>();
    Dictionary<string, object> requestHeader = new Dictionary<string, object>
    {
        { "OriginId", $"{Mother.Id}" },
        { "OriginName", Mother.Grid.CustomName },
        { "Path", "ping" },
        { "x", $"{currentPosition.X}" },
        { "y", $"{currentPosition.Y}" },
        { "z", $"{currentPosition.Z}" },
    };

    Request request = new Request(requestBody, requestHeader);

    SendOpenBroadcastRequest(request, OnPingResponse);
}
```

First we create the Request with the relevant payload - Body, and Header. Then we send it via open broadcast. Finally, we can set a callback to be run when a Response has been received to our outgoing message.

```csharp

void OnPingResponse(Response response)
{
    // Update Record in Almanac
    AlmanacRecord almanacRecord = new AlmanacRecord(
        response.BString("Id"),
        "grid",
        new Vector3D(
            response.BDouble("x"),
            response.BDouble("y"),
            response.BDouble("z")
        )
    );

    almanacRecord.AddNickname(response.HString("OriginName"));

    Mother.Almanac.AddRecord(almanacRecord);
}
```
### Sending a direct message
If you would like to send a direct message to another grid, this can be done via unicast. This is used when sending a remote command to another grid:

```csharp
# IntergridMessageService.cs
public void SendRequestFromRoutine(string target, TerminalRoutine routine)
{
    // get target grid from Almanac
    Grid grid = Mother.Almanac.GetGridByIdentifier(target);

    if (grid != null)
    {
        Request request = BuildCommandRequest(routine.UnpackedRoutineString);

        request.To(grid);

        SendUnicastRequest(grid.Id, request, null);
    }
}
```

### Sending Encrypted Messages
When playing in a PvP environment, it quickly becomes important to secure your communications so that other players cannot remotely command your grids running Mother.  To do this, we can use Mother's built in encryption. Let's take a look at how we are using this during message transmission:

```csharp
# IntergridMessageService.cs

public void SendUnicastRequest(long TargetId, IntergridMessageObject message, Action<IntergridMessageObject> onResponse)
{
    // Register the message callback
    activeRequests[$"{message.Header["Id"]}"] = onResponse;

    // encrypt the message if necessary
    string outgoingMessage = Encryption ?
        Mother.Security.Encrypt(message.Serialize()) :
        message.Serialize();

    // Send the message via unicast over the "default"
    bool success = Mother.IGC.SendUnicastMessage(TargetId, "default", outgoingMessage);

    if (!success)
    {
        Mother.EventBus.Emit(new RequestFailedEvent(), null);
    }
    else
    {
        Mother.EventBus.Emit(new RequestSentEvent(), null);
    }
}
```
### Using Channels


<!-- ## Almanac
1. Creating a new record
2. Updating a record
3. IFF
4. Ping -->
